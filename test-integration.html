<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StellarRec Integration Test - MockUniversity</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #1976d2;
      margin-bottom: 1rem;
    }
    
    .test-section {
      margin: 2rem 0;
      padding: 1.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    .test-section h3 {
      color: #333;
      margin-bottom: 1rem;
    }
    
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
      font-size: 0.9rem;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    .status {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .status.success {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    
    .status.error {
      background: #ffeaea;
      border: 1px solid #f44336;
      color: #c62828;
    }
    
    .status.info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
    }
    
    .log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }
    
    .integration-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }
    
    .status-indicator.active {
      background: #4caf50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎓 StellarRec Integration Test</h1>
    <p>This page tests the integration between StellarRec and MockUniversity's application system.</p>
    
    <div class="integration-status">
      <span class="status-indicator" id="integrationIndicator"></span>
      <span id="integrationStatus">Checking integration status...</span>
    </div>
    
    <div class="test-section">
      <h3>🔧 Integration Status</h3>
      <button onclick="checkIntegration()">Check Integration</button>
      <button onclick="clearLogs()">Clear Logs</button>
      <div id="integrationResult" class="status info" style="display: none;"></div>
    </div>
    
    <div class="test-section">
      <h3>📨 Test Recommendation Sending</h3>
      <p>Simulate sending a recommendation from StellarRec to MockUniversity:</p>
      <button onclick="sendTestRecommendation()">Test Full Workflow (Pending → Completed)</button>
      <button onclick="sendPendingOnly()">Send Pending Request Only</button>
      <button onclick="sendMultipleRecommendations()">Send Multiple (3)</button>
      <div id="sendResult" class="status" style="display: none;"></div>
    </div>
    
    <div class="test-section">
      <h3>🔄 Test Message Communication</h3>
      <p>Test the postMessage communication between StellarRec and MockUniversity:</p>
      <button onclick="testPostMessage()">Test PostMessage</button>
      <button onclick="openApplyPage()">Open Apply Page</button>
      <div id="messageResult" class="status" style="display: none;"></div>
    </div>
    
    <div class="test-section">
      <h3>💾 Local Storage</h3>
      <button onclick="viewStoredRecommendations()">View Stored Recommendations</button>
      <button onclick="clearStoredRecommendations()">Clear Storage</button>
      <div id="storageResult" class="status" style="display: none;"></div>
    </div>
    
    <div class="test-section">
      <h3>📋 Activity Log</h3>
      <div id="activityLog" class="log">Integration test page loaded...\n</div>
    </div>
  </div>
  
  <script src="js/stellarrec-integration.js"></script>
  
  <script>
    let logElement;
    
    document.addEventListener('DOMContentLoaded', function() {
      logElement = document.getElementById('activityLog');
      log('Test page initialized');
      
      // Initialize integration
      if (window.StellarRecIntegration) {
        window.StellarRecIntegration.initialize();
        updateIntegrationStatus(true);
        log('StellarRec integration initialized');
      } else {
        updateIntegrationStatus(false);
        log('ERROR: StellarRec integration not found');
      }
      
      // Listen for messages
      window.addEventListener('message', function(event) {
        log(`Message received from ${event.origin}: ${JSON.stringify(event.data)}`);
      });
    });
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    function updateIntegrationStatus(active) {
      const indicator = document.getElementById('integrationIndicator');
      const status = document.getElementById('integrationStatus');
      
      if (active) {
        indicator.classList.add('active');
        status.textContent = 'Integration Active ✅';
      } else {
        indicator.classList.remove('active');
        status.textContent = 'Integration Inactive ❌';
      }
    }
    
    function checkIntegration() {
      const result = document.getElementById('integrationResult');
      
      if (window.StellarRecIntegration) {
        const recommendations = window.StellarRecIntegration.getRecommendations();
        result.className = 'status success';
        result.textContent = `Integration OK. ${recommendations.length} recommendations stored.`;
        log(`Integration check: OK (${recommendations.length} recommendations)`);
      } else {
        result.className = 'status error';
        result.textContent = 'Integration not found or not initialized.';
        log('Integration check: FAILED');
      }
      
      result.style.display = 'block';
    }
    
    function sendTestRecommendation() {
      const result = document.getElementById('sendResult');
      
      if (!window.StellarRecIntegration) {
        result.className = 'status error';
        result.textContent = 'Integration not available';
        result.style.display = 'block';
        return;
      }
      
      // First send a recommendation REQUEST (Pending status)
      const testRequest = {
        id: 'req_' + Date.now(),
        recommenderName: 'Prof. Manas Mohan Nand',
        recommenderEmail: 'manasnandmohan@gmail.com',
        recommenderTitle: 'Professor of Historical Studies',
        studentName: 'Student Applicant',
        studentEmail: 'swetha.rajan103@gmail.com',
        program: 'MA Historical Studies',
        status: 'Pending',
        requestedAt: new Date().toISOString(),
        source: 'StellarRec (Test)'
      };
      
      // Simulate the REQUEST message from StellarRec
      const requestMessage = {
        type: 'RECOMMENDATION_REQUEST',
        request: testRequest,
        messageId: 'test_req_' + Date.now()
      };
      
      // Send the request message
      window.postMessage(requestMessage, window.location.origin);
      
      result.className = 'status success';
      result.textContent = `Test recommendation request sent for ${testRequest.studentName} - Status: Pending`;
      result.style.display = 'block';
      
      log(`Sent test recommendation request: ${testRequest.recommenderName} -> ${testRequest.studentName} (Status: Pending)`);
      
      // After 3 seconds, simulate completion
      setTimeout(() => {
        sendCompletedRecommendation(testRequest);
      }, 3000);
    }
    
    function sendCompletedRecommendation(originalRequest) {
      const completedRecommendation = {
        ...originalRequest,
        id: originalRequest.id,
        status: 'Completed',
        content: 'This is a completed recommendation letter for the student. The student has demonstrated exceptional academic performance and leadership qualities...',
        fileUrl: 'https://example.com/recommendations/sample-recommendation.pdf',
        fileType: 'PDF',
        completedAt: new Date().toISOString(),
        submittedAt: new Date().toISOString()
      };
      
      // Simulate the COMPLETED message from StellarRec
      const completedMessage = {
        type: 'RECOMMENDATION_SENT',
        recommendation: completedRecommendation,
        messageId: 'test_completed_' + Date.now()
      };
      
      // Send the completed message
      window.postMessage(completedMessage, window.location.origin);
      
      const result = document.getElementById('sendResult');
      result.className = 'status success';
      result.textContent = `Recommendation completed! Status: Completed, File: ${completedRecommendation.fileType}`;
      result.style.display = 'block';
      
      log(`Recommendation completed: ${completedRecommendation.recommenderName} -> ${completedRecommendation.studentName} (Status: Completed, File: ${completedRecommendation.fileType})`);
    }
    
    function sendPendingOnly() {
      const result = document.getElementById('sendResult');
      
      const testRequest = {
        id: 'pending_' + Date.now(),
        recommenderName: 'Prof. Manas Mohan Nand',
        recommenderEmail: 'manasnandmohan@gmail.com',
        recommenderTitle: 'Professor of Historical Studies',
        studentName: 'Student Applicant',
        studentEmail: 'swetha.rajan103@gmail.com',
        program: 'MA Historical Studies',
        status: 'Pending',
        requestedAt: new Date().toISOString(),
        source: 'StellarRec (Test)'
      };
      
      const requestMessage = {
        type: 'RECOMMENDATION_REQUEST',
        request: testRequest,
        messageId: 'pending_msg_' + Date.now()
      };
      
      window.postMessage(requestMessage, window.location.origin);
      
      result.className = 'status info';
      result.textContent = `Pending recommendation request sent - will stay in "Pending" status`;
      result.style.display = 'block';
      
      log(`Sent pending-only request: ${testRequest.recommenderName} -> ${testRequest.studentName}`);
    }
    
    function sendMultipleRecommendations() {
      const recommendations = [
        {
          recommenderName: 'Prof. Michael Davis',
          recommenderEmail: 'michael.davis@tech.edu',
          recommenderTitle: 'Department Head, Engineering',
          studentName: 'Emma Wilson',
          program: 'Engineering'
        },
        {
          recommenderName: 'Dr. Lisa Park',
          recommenderEmail: 'lisa.park@business.edu',
          recommenderTitle: 'Associate Professor',
          studentName: 'James Rodriguez',
          program: 'Business Administration'
        },
        {
          recommenderName: 'Prof. David Kim',
          recommenderEmail: 'david.kim@science.edu',
          recommenderTitle: 'Research Director',
          studentName: 'Sophia Taylor',
          program: 'Biotechnology'
        }
      ];
      
      recommendations.forEach((rec, index) => {
        setTimeout(() => {
          const testRec = {
            id: 'multi_test_' + Date.now() + '_' + index,
            ...rec,
            studentEmail: rec.studentName.toLowerCase().replace(' ', '.') + '@student.edu',
            status: 'Received',
            content: `Recommendation letter for ${rec.studentName}...`,
            submittedAt: new Date().toISOString(),
            source: 'StellarRec (Multi-Test)'
          };
          
          const message = {
            type: 'RECOMMENDATION_SENT',
            recommendation: testRec,
            messageId: 'multi_msg_' + Date.now() + '_' + index
          };
          
          window.postMessage(message, window.location.origin);
          log(`Sent recommendation ${index + 1}/3: ${rec.recommenderName} -> ${rec.studentName}`);
        }, index * 500);
      });
      
      const result = document.getElementById('sendResult');
      result.className = 'status success';
      result.textContent = 'Sending 3 test recommendations...';
      result.style.display = 'block';
    }
    
    function testPostMessage() {
      const result = document.getElementById('messageResult');
      
      // Test ping message
      const pingMessage = {
        type: 'PING',
        timestamp: new Date().toISOString(),
        source: 'test-page'
      };
      
      window.postMessage(pingMessage, window.location.origin);
      
      result.className = 'status info';
      result.textContent = 'Ping message sent. Check activity log for response.';
      result.style.display = 'block';
      
      log('Sent ping message');
    }
    
    function openApplyPage() {
      const applyWindow = window.open('apply.html', 'mockUniversityApply', 'width=1200,height=800');
      
      if (applyWindow) {
        log('Opened apply page in new window');
        
        // Send a test message after a delay
        setTimeout(() => {
          const testMessage = {
            type: 'RECOMMENDATION_SENT',
            recommendation: {
              id: 'window_test_' + Date.now(),
              recommenderName: 'Dr. Window Test',
              recommenderEmail: 'window.test@university.edu',
              recommenderTitle: 'Test Professor',
              studentName: 'Test Student',
              studentEmail: 'test.student@student.edu',
              program: 'Test Program',
              status: 'Received',
              content: 'This is a test recommendation sent to the apply page window.',
              submittedAt: new Date().toISOString(),
              source: 'StellarRec (Window Test)'
            },
            messageId: 'window_msg_' + Date.now()
          };
          
          applyWindow.postMessage(testMessage, window.location.origin);
          log('Sent test recommendation to apply page window');
        }, 2000);
      } else {
        log('Failed to open apply page (popup blocked?)');
      }
    }
    
    function viewStoredRecommendations() {
      const result = document.getElementById('storageResult');
      const stored = JSON.parse(localStorage.getItem('mockUniversityRecommendations') || '[]');
      
      if (stored.length === 0) {
        result.className = 'status info';
        result.textContent = 'No recommendations stored.';
      } else {
        result.className = 'status success';
        result.innerHTML = `<strong>${stored.length} recommendations stored:</strong><br>` +
          stored.map(r => `• ${r.recommenderName} → ${r.studentName} (${r.status})`).join('<br>');
      }
      
      result.style.display = 'block';
      log(`Viewed storage: ${stored.length} recommendations found`);
    }
    
    function clearStoredRecommendations() {
      localStorage.removeItem('mockUniversityRecommendations');
      
      const result = document.getElementById('storageResult');
      result.className = 'status info';
      result.textContent = 'Storage cleared.';
      result.style.display = 'block';
      
      log('Cleared stored recommendations');
    }
    
    function clearLogs() {
      logElement.textContent = 'Logs cleared...\n';
    }
    
    // Global test function
    window.testStellarRecIntegration = function() {
      log('Running full integration test...');
      checkIntegration();
      setTimeout(() => sendTestRecommendation(), 1000);
      setTimeout(() => viewStoredRecommendations(), 2000);
    };
  </script>
</body>
</html>